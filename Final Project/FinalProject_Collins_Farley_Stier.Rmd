---
title: "S&DS 563/S&DS 363 Final Project"
author: "Evan Collins, Kelly Farley, Ken Stier"
date: "15 May 2021"
output:
  html_document:
   toc: yes
   toc_float:
     collapsed: no
  pdf_document:
    latex_engine : xelatex
---

```{r include = FALSE}
# hides code chunks globally
knitr::opts_chunk$set(echo=FALSE)
```

```{r, message=F, warning=F, results = "hide", cache=TRUE}
library(dplyr)
library(corrplot)
library(PerformanceAnalytics)
library(FactoMineR)
library(car)
library(tidyverse)
library(Rmisc)
library(MASS)
library(biotools)
library(DiscriMiner)
library(klaR)
library(heplots)
library(ggplot2)
library(cluster)
library(fpc)
library(vegan)
library(mgcv)
library(dplyr)
library(magrittr)
source("http://www.reuningscherer.net/multivariate/R/CSQPlot.r.txt")
source("http://reuningscherer.net/multivariate/R/HClusEval3.R.txt")
```


# Introduction

With the nadir of the SARS-CoV-2 pandemic finally subsiding, the task of understanding the epidemiological factors contributing to the propagation of COVID-19 has only begun. Understanding relationships between COVID-19 spread prevention and socioeconomic variables will prove vital to inform us of how to mitigate the propagation of the next pandemic. This report aims to understand how the economic, education, behavioral, and population data for the 3141 U.S. counties relate to COVID-19 case data.

We acknowledge that the impact of and response to COVID-19 has been very different from county to county. Looking at the [current COVID-19 vaccination data in mid-May 2020](https://www.nytimes.com/interactive/2020/us/covid-19-vaccine-doses.html), we note that the vaccination rate for ages 18+ ranges from 11% in some counties in Louisiana to 74% in some counties in New York.  Our guiding question is: Who is the most vulnerable to COVID-19 infection and death? This knowledge will guide public health efforts as we continue to fight against the spread of COVID-19. Knowledge of what socioeconomic factors put people at risk will allow us to prioritize our vaccination and education efforts from those who need it the most and will also let us take a step back to acknowledge the systemic health inequalities in our country.


# Design and Primary Questions

This report deploys three multivariate techniques to examine three questions in particular:

1. How do the 3141 counties differ from one another, i.e., how do the socioeconomic and COVID-19 data relate to one another when distinguishing U.S. counties? Principal components analysis (PCA) will help to reduce the dimensionality of our large dataset, increasing interpretability of underlying trends between clusters of variables. This metric technique works on the "columns" of our data set to reduce them into composite variables and make them more interpretable.

2. Which U.S. states are similar to one another? Cluster analysis will enable the clustering of states into a discrete number of groups based on similar socioeconomic and COVID-19 data. Aggregating by state will enable more effective visualizations. This metric technique works on the rows of our data set to find similar groups of observations aggregated by state.

3. Which U.S. county variable pairings are similar to one another? Correspondence analysis is similar to PCA but applies to categorical rather than continuous variables. This nonmetric technique works on both the "columns" and "rows" of our data set to visualize which rows and column points are similar in lower-dimensional space.

Using these techniques, we will be able to better understand our variables, our observations, and the interactions between our variables and observations. Who is most vulnerable to COVID-19 infection and death? This allows us to direct resources to protecting these vulnerable populations.


# Data

The dataset referenced in this report includes COVID-19 infection and death statistics from U.S. counties (sourced from Johns Hopkins, as of 28 April 2021), combined with economic, education, and population data (sourced from various government agencies) and also survey responses about mask-wearing frequencies (sourced from NYT). 

3141 complete observations on 10 continuous variables and 6 categorical variables. Continuous variables were rescaled as percentages of county population.

- **6 categorical variables**: FIPS, county name, state name, rural urban type, rural urban code, economic typology

- **9 continuous variables**: "Always" wear mask survey response percent, unemployment rate, median household income, percent poverty, percent of adults with less than a high school education, death rate, percent civilian labor force, percent of county population that has had confirmed COVID-19 cases, and percent of county population that has died from COVID-19. 

[1] “FIPS” = State-County FIPS Code; Categorical (identifier)

[2] “County_Name” = US County Name; Categorical (identifier)

[3] “State_Name” = US State Name; Categorical

[4] “Rural_Urban_Type” = Regrouping of Rural-Urban Codes (2013) numbered 1-9 according to descriptions provided by the USDA. See variable [5]. Regroup codes 1 through 9 into three groups: (1) “Urban” for codes 1-3, (2) “Suburban” for codes 4-6, and (3) “Rural” for codes 7-9; Categorical (1-3)

[5] “Rural_Urban_Code_2013” = Rural-urban Continuum Code, 2013; (https://www.ers.usda.gov/data-products/rural-urban-continuum-codes/); Categorical (1-9)

[6] “Economic_Typology_2015” = County economic types, 2015 edition (https://www.ers.usda.gov/data-products/county-typology-codes/); Non-overlapping economic-dependence county indicator. 0=Nonspecialized 1=Farm-dependent 2=Mining-dependent 3=Manufacturing-dependent 4=Federal/State government-dependent 5=Recreation; Categorical (0-5)

[7] “Always_Wear_Mask_Survey” = “Always” response. The New York Times administered a survey to 250,000 Americans from July 2 to July 14 asking the following question: How often do you wear a mask in public when you expect to be within six feet of another person?; Continous (%)

[8] “Unemployment_Rate_2019” = Unemployment rate, 2019; Continuous (%)

[9] “Median_Household_Income_2019” = Estimate of median household Income, 2019; Continous ($)

[10] “Percent_Poverty_2019” = Estimate of people of all ages in poverty 2019; Continuous (%)

[11] “Percent_Adults_Less_Than_HS” = Percent of adults with less than a high school diploma, 2014-18

[12] “Death_Rate_2019” = Death rate in period 7/1/2018 to 6/30/2019; Continuous (%)

[13] “Civilian_Labor_Force_2019_as_pct” = Civilian labor force annual average, 2019, expressed as percent; Continuous (%)

[14] “Covid_Confirmed_Cases_as_pct” = Cumulative sum of COVID-19 cases expressed as percent. Reported from Johns Hopkins on 28 April 2021; Continuous (%)

[15] “Covid_Deaths_as_pct” = Cumulative sum of COVID-19 deaths expressed as percent. Reported from Johns Hopkins on 28 April 2021; Continuous (%)


```{r}
raw <- read.csv("https://evancollins.com/covid_and_demographics_final.csv")

# Regroup Rural-Urban Codes
raw$Rural_Urban_Type <- raw$Rural_Urban_Code_2013
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 1] <- "Urban"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 2] <- "Urban"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 3] <- "Urban"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 4] <- "Suburban"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 5] <- "Suburban"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 6] <- "Suburban"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 7] <- "Rural"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 8] <- "Rural"
raw$Rural_Urban_Type[raw$Rural_Urban_Code_2013 == 9] <- "Rural"

# log transformations of our continuous variables
raw$logMedian_Household_Income_2019 <- log(raw$Median_Household_Income_2019 + 0.0001)
raw$logPercent_Poverty_2019 <- log(raw$Percent_Poverty_2019 + 0.0001)
raw$logCovid_Confirmed_Cases_as_pct <- log(raw$Covid_Confirmed_Cases_as_pct + 0.0001)

# Reduce dataset to variables of interest
raw <- raw[, -1]
raw <- raw[, c(1, 2, 3, 8, 9, 10, 12, 13, 17, 19, 20, 21, 22, 24, 25)]

# reorder data so categorical variables are first
raw <- raw[, c(3, 1, 2, 15, 10, 11, 4, 5, 6, 7, 8, 9, 14, 12, 13)]
```


```{r, results = "hide", fig.show = "hide"}
boxplot(raw[, c(7:15)])
```

```{r, results = "hide", fig.show = "hide"}
library(car)
for (i in 7:15){
 qqPlot(raw[, c(i)]) 
}
```

```{r}
# Take log of every continuous variable
raw_trans <- raw
raw_trans$Always_Wear_Mask_Survey_Log <- log(raw_trans$Always_Wear_Mask_Survey + 0.01)
raw_trans$Unemployment_Rate_2019_Log <- log(raw_trans$Unemployment_Rate_2019 + 0.01)
raw_trans$Median_Household_Income_2019_Log <- log(raw_trans$Median_Household_Income_2019 + 0.01)
raw_trans$Percent_Poverty_2019_Log <- log(raw_trans$Percent_Poverty_2019 + 0.01)
raw_trans$Percent_Adults_Less_Than_HS_Log <- log(raw_trans$Percent_Adults_Less_Than_HS + 0.01)
raw_trans$Death_Rate_2019_Log <- log(raw_trans$Death_Rate_2019 + 0.01)
raw_trans$Civilian_Labor_Force_2019_as_pct_Log <- log(raw_trans$Civilian_Labor_Force_2019_as_pct + 0.01)
raw_trans$Covid_Confirmed_Cases_as_pct_Log <- log(raw_trans$Covid_Confirmed_Cases_as_pct + 0.01)
raw_trans$Covid_Deaths_as_pct_Log <- log(raw_trans$Covid_Deaths_as_pct + 0.01)

# Log only data
raw_trans_log <- raw_trans[, c(1:6, 16:24)]
```

```{r}
# Standardize variables since on different scales
library(dplyr)
scaled_dat_log <- raw_trans_log %>% mutate_at(c(7:15), ~(scale(.) %>% as.vector))
```

```{r, results = "hide", fig.show = "hide"}
boxplot(scaled_dat_log[, c(7:15)])
```

```{r, results = "hide", fig.show = "hide"}
for (i in 7:15){
 qqPlot(scaled_dat_log[, c(i)]) 
}
```

```{r, results = "hide", fig.show = "hide"}
db <- scaled_dat_log

# Covid cases outlier exclusion
db[which(db$Covid_Confirmed_Cases_as_pct_Log > quantile(db$Covid_Confirmed_Cases_as_pct_Log, .25) - 1.5*IQR(db$Covid_Confirmed_Cases_as_pct_Log) & db$Covid_Confirmed_Cases_as_pct_Log < quantile(db$Covid_Confirmed_Cases_as_pct_Log, .75) + 1.5*IQR(db$Covid_Confirmed_Cases_as_pct_Log)),] -> db_clean

# Report percentage of items this restriction included
# 6% is sufficiently low
(length(db$Covid_Confirmed_Cases_as_pct_Log) - length(db_clean$Covid_Confirmed_Cases_as_pct_Log)) / length(db$Covid_Confirmed_Cases_as_pct_Log)


# Covid deaths outlier exclusion
db_clean[which(db_clean$Covid_Deaths_as_pct_Log > quantile(db_clean$Covid_Deaths_as_pct_Log, .25) - 1.5*IQR(db_clean$Covid_Deaths_as_pct_Log) & db_clean$Covid_Deaths_as_pct_Log < quantile(db_clean$Covid_Deaths_as_pct_Log, .75) + 1.5*IQR(db_clean$Covid_Deaths_as_pct_Log)),] -> db_clean1

# Report percentage of items this restriction included
# 2% is sufficiently low
(length(db_clean$Covid_Deaths_as_pct_Log) - length(db_clean1$Covid_Deaths_as_pct_Log)) / length(db_clean$Covid_Deaths_as_pct_Log)


# Death rate outlier exclusion
db_clean1[which(db_clean1$Death_Rate_2019_Log > quantile(db_clean1$Death_Rate_2019_Log, .25) - 1.5*IQR(db_clean1$Death_Rate_2019_Log) & db_clean1$Death_Rate_2019_Log < quantile(db_clean1$Death_Rate_2019_Log, .75) + 1.5*IQR(db_clean1$Death_Rate_2019_Log)),] -> db_clean2

# Report percentage of items this restriction included
# 3% is sufficiently low
(length(db_clean1$Death_Rate_2019_Log) - length(db_clean2$Death_Rate_2019_Log)) / length(db_clean1$Death_Rate_2019_Log)

scaled_dat_log_clean <- db_clean2
```

# Descriptive Plots and Summary Statistics

```{r, results = "hide", fig.show = "hide"}
for (i in 7:15){
 qqPlot(scaled_dat_log_clean[, c(i)]) 
}
```


We made normal quantile plots for each of the 9 continuous variables in the dataset. This revealed that most variables initially did not have a univariate normal distribution. Taking the log-transform of the 10 continuous variables helped most variables have more linear quantile plots. Note that we also standardized the continuous variables since they were measured on different scales. Moreover, for death rate, percent COVID-19 cases, percent COVID-19 deaths, a 1.5 x IQR outlier exclusion method was applied to enable these variables to take on more normal univariate distributions. Note that the outlier exclusion method reduced the number of counties that we will analyze to 2,814 observation. Hence, outlier exclusion reduced the dataset by approximately 10%. This percent excluded is relatively substantial; however, we deemed the benefits of having univariate distributions outweighed this disadvantage. With these changes made, the 9 continuous variables all had univariate normal distributions.

```{r}
CSQPlot(scaled_dat_log_clean[, 7:15], label = "Counties")
```

A chi-square quantile plot (shown above) reflects that our data does not have a multivariate normal distribution. Thus, none of the techniques we use will require a multivariate normal distribution.

```{r}
library(corrplot)
corrplot.mixed(round(cor(scaled_dat_log_clean[7:15]), 2), lower.col = "black", upper = "ellipse", tl.col = "black", number.cex = .3, order = "hclust", tl.pos = "lt", tl.cex = .25)
```

We note many variables highly correlated with other variables, which is good news for PCA. For instance, the correlation between the log of the unemployment rate and the labor force as a percent is -.065, the correlation between the log of the median household income and percent poverty is -0.88, and the correlation between the percent of COVID-19 cases and the percent of COVID-19 deaths is 0.47. There appear to be underlying trends about the counties (about beliefs about COVID-19, about wealth/education, etc) that could be summarized in linear combinations of the 19 metric variables we have currently.

```{r}
dim(scaled_dat_log_clean)
table(scaled_dat_log_clean$Rural_Urban_Type)
table(scaled_dat_log_clean$Economic_Typology_2015)
summary(scaled_dat_log_clean[,6:15])
boxplot(scaled_dat_log_clean[,7:15])
```

From the 2,814 US counties that we are analyzing, there is a fairly equitable distribution of rural-urban type: 907 rural, 841 suburban, and 1066 urban. The distributions in the quantitative variables are pretty consistent, as we expected considering our previous standardization operation of continuous variables. 

```{r}
stlogdata <- scaled_dat_log_clean

# this is redundant, as we have already standardized the data
#for(i in 7:15) {
#  stlogdata[,i] <- (stlogdata[,i] - mean(stlogdata[,i])) / sd(stlogdata[,i])
#}
#boxplot(stlogdata[,7:15])
```

# Principle Components Analysis

```{r}
stlm <- stlogdata[,7:15]

pc1 <- princomp(stlm, cor=TRUE) # run PCA on correlation matrix

print(summary(pc1), digits = 2, loadings=pc1$loadings, cutoff=0) # results

round(pc1$sdev^2, 2) # eigenvalues

screeplot(pc1,type="lines",col="red",lwd=2,pch=19,cex=1.2,main="Scree Plot of Transformed COVID-19 Data") # screeplot
```

According to the total variance explained method, using a cutoff of 1, the first 3 PC's should be used. According to the Eigenvalue > 1 method, the first 3 PC's should be used. According to the scree plot elbow method, the first 1 PC's should be used. We choose to maintain the first 3 PC's in accordance with the first two methods for a parsimonous but still informative model.

```{r}
print(summary(pc1), digits = 2, loadings=pc1$loadings, cutoff=0)
```

Looking at PC1: This principle component seems to be related to wealth, work status, and education. It combines log percent poverty (-0.46) with the log of the median household income (0.45), the log of the civilian labor force (0.41), and the percent of adults with a bachelor’s degree or higher (-0.39). A higher value on this PC indicates more employment, more jobs, and more education.

Looking at PC2: This principle component seems to be a measure of masking behaviors and relation to COVID-19 infection. It combines the percentage of those who say they always mask (0.52), the log of the COVID-19 infection rate (-0.60), and the log of the COVID-19 death rate (-0.46). A higher value on this PC indicates more masking and less COVID-19 infection and death.

Looking at PC3: This principle component seems to be a combination of the first two and relates underlying traits about the county to COVID-19 infection. It combines the log of the 2019 death rate (-0.51) with the cumulative percentage of population with the log of the percentage of adults with less than a high school degree (0.32), the log of the COVID-19 infection rate (0.40), and the log of the COVID-19 death rate (0.31). A higher value on this PC indicates less education and more COVID-19 infection and death.

Using PCA, we can reduce these 9 metric variables to 3 composite variables that are related to wealth and education, attitudes about masking, and population. These 3 PC’s can account for 73% of the total variability, which is fairly effective! We note that COVID-19 infection and death rates are related to attitudes and behaviors, like the masking rate, but is also due to factors outside of the control of a county's population, like unemployment and education.

# Cluster Analysis (fix hclus_eval)

```{r}
euclid <- dist(stlogdata[,7:15], method="euclidean")
euclusters_ward <- hclust(euclid, method="ward.D")
plot(euclusters_ward,labels=as.vector(stlogdata[,"County_Name"]),cex=0.1,xlab="",ylab="Distance",lwd=0.2, main="Euclidean Distance & Ward Clustering")
```

```{r}
# hclus_eval(stlogdata[,7:15], dist_m = 'euclidean', clus_m = 'ward.D', plot_op = T, print_num = 15)
```

There are peaks in the RMSSTD at 3, 9, and most notably 12,indicating that these may be reasonable group counts. SPRSQ tapers at 9, supporting the idea that there may be 9 groups. However, the tapering is far more prominent at 2 and 4 and is echoed in the RSQ, so a lower group count may be indicated. Let's go back to the dendrogram to see how this fits.

```{r}
plot(euclusters_ward,labels=as.vector(stlogdata[,"County_Name"]),cex=0.1,xlab="",ylab="Distance",lwd=0.2, main="Euclidean Distance & Ward Clustering"); rect.hclust(euclusters_ward, k = 3)

plot(euclusters_ward,labels=as.vector(stlogdata[,"County_Name"]),cex=0.1,xlab="",ylab="Distance",lwd=0.2, main="Euclidean Distance & Ward Clustering"); rect.hclust(euclusters_ward, k = 9)

plot(euclusters_ward,labels=as.vector(stlogdata[,"County_Name"]),cex=0.1,xlab="",ylab="Distance",lwd=0.2, main="Euclidean Distance & Ward Clustering"); rect.hclust(euclusters_ward, k = 12)
```

The large spike in RMSSTD is very promising, and the dendrogram clustering looks apt as well, but we don't want to run the risk of having too many clusters!

```{r}
library(cluster)

cuts3 <- cutree(euclusters_ward, k=3)
cuts9 <- cutree(euclusters_ward, k=9)
cuts12 <- cutree(euclusters_ward, k=12)

clusplot(stlogdata[,7:15], cuts3, color = TRUE, shade = TRUE, labels = 0, lines = 0, main = "County Cluster Plot, Ward's Method, First two PC, 3 groups", cex = .1)

clusplot(stlogdata[,7:15], cuts9, color = TRUE, shade = TRUE, labels = 0, lines = 0, main = "County Cluster Plot, Ward's Method, First two PC, 9 groups", cex = .1)

clusplot(stlogdata[,7:15], cuts12, color = TRUE, shade = TRUE, labels = 0, lines = 0, main = "County Cluster Plot, Ward's Method, First two PC, 12 groups", cex = .1)
```
```{r}
plotcluster(stlogdata[,7:15], cuts3, main = "Four Cluster Solution in DA Space, 3 groups", xlab = "First Discriminant Function", ylab = "Second Discriminant Function", cex = .4)

plotcluster(stlogdata[,7:15], cuts9, main = "Four Cluster Solution in DA Space, 9 groups", xlab = "First Discriminant Function", ylab = "Second Discriminant Function", cex = .4)

plotcluster(stlogdata[,7:15], cuts12, main = "Four Cluster Solution in DA Space, 12 groups", xlab = "First Discriminant Function", ylab = "Second Discriminant Function", cex = .4)
```

```{r}
fit <- kmeans(stlm, 3)
aggregate(stlm, by=list(fit$cluster), FUN=mean)
```

Recall that we are clustering U.S. counties based on 9 metric, standardized variables. We are trying to find groups of counties with members that are similar to each other but different from other groups - we are finding clusters of *observations*, unlike PCA where we found clusters of *variables.* For the most parsimonous model, we examine 3 clusters that primarily differ on their wealth/education/employment and COVID-19 infection and death rates.

Clusters 1 and 3 are relatively well-off economically. Both have high household incomes, low poverty rates, high civilian labor forces, low unemployment rates, and high education rates. Cluster 3 is more well-off than Cluster 1, perhaps representing those with higher paying jobs. The biggest difference, though, is in COVID-19 responses. Cluster 1 has high COVID-19 infection (0.53) and death rates (0.22), while Cluster 3 has low COVID-19 infection (-0.60) and death rates (-0.75). This difference can potentially be tied back to behavioral differences: counties in Cluster 3 always mask (0.68) while counties in Cluster 1 do not (-0.88). It is important to note that this difference is not necessarily due to any sort of moral gap but more likely due to a gap in resources - it is a privilege to be able to stay informed on scientific discoveries, purchase masks, and maintain social distancing.

In contrast to Clusters 1 and 3, Cluster 2 is underprivileged, with low household income (-0.82), high poverty (0.85), low civilian labor force (-0.82), and a high percent with less than a high school degree (0.76). Cluster 2 is  hit the hardest by COVID-19, with the highest death rate (0.42). Here we most clearly see the connection between underlying economic factors and the impact of COVID-19.  Members of these communities tend to have jobs as essential workers that require work outside of the home. They may have to take public transit. They may be unable to afford grocery delivery services. Affluent communities have the resources to avoid COVID-19 transmission, while impoverished communities may not. These communities are likely to have preexisting conditions that worsen its effects and may lack quality healthcare or health insurance. We also note a potential gap in testing in these communities - death rates are high, but the reported infection rate is incredibly low (-0.01). As we continue to distribute COVID-19 vaccinations, special attention should be placed on supporting these communities most at risk for severe negative consequences associated with COVID-19.

# Correspondence Analysis

With correspondence analysis, we are seeking to answer the question: Which U.S. states are similar to one another? Correspondence analysis is similar to PCA but applies to categorical rather than continuous variables. In this part of the report, we analyze aggregate statistics by state, i.e., taking  means of continuous variables for all counties in each state. Organizing by the 50 states + D.C. will allow for more insightful visualizations.

Of our original 9 continuous variables, we assign 5 continuous variables for correspondence analysis: Always_Wear_Mask_Survey, Median_Household_Income_2019, Percent_Poverty_2019, Percent_Adults_Less_Than_HS, and Covid_Confirmed_Cases_as_pct.

For additional continuous variables, we make an environmental dataset. We look at four additional continuous variables describing each state: Unemployment_Rate_2019, Death_Rate_2019, Civilian_Labor_Force_2019_as_pct, and Covid_Deaths_as_pct. 

```{r}
stlm_CA_og <- scaled_dat_log[, c(1,3, 7:15)]

# get averages of each variable by state
stlm_CA_raw <- aggregate(Always_Wear_Mask_Survey_Log ~ State_Name, stlm_CA_og, mean)
stlm_CA_raw$Unemployment_Rate_2019_Log <- aggregate(Unemployment_Rate_2019_Log ~ State_Name, stlm_CA_og, mean)$Unemployment_Rate_2019_Log
stlm_CA_raw$Median_Household_Income_2019_Log <- aggregate(Median_Household_Income_2019_Log ~ State_Name, stlm_CA_og, mean)$Median_Household_Income_2019_Log
stlm_CA_raw$Percent_Poverty_2019_Log <- aggregate(Percent_Poverty_2019_Log ~ State_Name, stlm_CA_og, mean)$Percent_Poverty_2019_Log
stlm_CA_raw$Percent_Adults_Less_Than_HS_Log <- aggregate(Percent_Adults_Less_Than_HS_Log ~ State_Name, stlm_CA_og, mean)$Percent_Adults_Less_Than_HS_Log
stlm_CA_raw$Death_Rate_2019_Log <- aggregate(Death_Rate_2019_Log ~ State_Name, stlm_CA_og, mean)$Death_Rate_2019_Log
stlm_CA_raw$Civilian_Labor_Force_2019_as_pct_Log <- aggregate(Civilian_Labor_Force_2019_as_pct_Log ~ State_Name, stlm_CA_og, mean)$Civilian_Labor_Force_2019_as_pct_Log
stlm_CA_raw$Covid_Confirmed_Cases_as_pct_Log <- aggregate(Covid_Confirmed_Cases_as_pct_Log ~ State_Name, stlm_CA_og, mean)$Covid_Confirmed_Cases_as_pct_Log
stlm_CA_raw$Covid_Deaths_as_pct_Log <- aggregate(Covid_Deaths_as_pct_Log ~ State_Name, stlm_CA_og, mean)$Covid_Deaths_as_pct_Log
```

Because correspondence analysis requires continuous variables to take on positive values, we applied a +2.5 pseudoshift to all values. 

```{r}
stlm_CA_raw1 <- stlm_CA_raw
rownames(stlm_CA_raw) <- stlm_CA_raw1[,1] 
stlm_CA_raw <- stlm_CA_raw[,-1]

stlm_CA_raw_pos <- stlm_CA_raw[, c(1:9)] + 2.5

stlm_CA_raw_pos <- stlm_CA_raw_pos[-45, ]

# Split up dataset into continuous variables and environmental variables
stlm_CA_cont <- stlm_CA_raw_pos[,c(1,3,4,5,8)]
stlm_CA_env <- stlm_CA_raw_pos[,c(2,6,7,9)]



#Perform correspondence analysis
stlm_CA <- cca(stlm_CA_cont)

summary(stlm_CA)
```

Equal to squared eigenvalues, inertia is like variance and measures departures from the independence model. We see that the inertia value is 0.06632. The magnitude of inertia does not reflect more or less variance; it is reflective of the magnitude of the data.

From the output data above in the "proportion explained” row, we can see that first direction explains ~62.9% of the relation. The “cumulative proportion” by the second direction is ~91.1%. Hence, the first two directions explain the vast majority of total inertia. The third and fourth directions have significantly smaller "proportion explained” values. This suggests that there are likely two major underlying discriminatory dimensions captured by the data of the 50 U.S. states (which reflect aggregate county data). To get a sense of these correspondence analysis directions, we subsequently plotted them.

```{r, message=F, warning=F, results = "hide"}
# we will hide these results
# CA w/o env variables
#plot results
plot(stlm_CA, main = "Correspondence Analysis for U.S. States", type = "n")
text(stlm_CA, dis = "wa", labels = rownames(stlm_CA_cont), cex = 0.3)
points(stlm_CA, pch = 21, col = "red", bg = "red", cex = .5)
text(stlm_CA, "species", col = "blue", cex = 0.5)
```

```{r}
plot(stlm_CA, main = "Correspondence Analysis for U.S. States", type = "n")
points(stlm_CA, pch = 19, col = "black", cex = .2)
text(stlm_CA, "species", col = "blue", cex = 0.6)
text(stlm_CA, dis = "wa", labels = rownames(stlm_CA_cont), cex = 0.3)
#add environmental variables
fit <- envfit(stlm_CA, stlm_CA_env, permutations = 1000)
plot(fit, col = "red", lwd = 3, cex=0.8)
```

```{r}
fit <- envfit(stlm_CA, stlm_CA_env, permutations = 1000)
fit
```

We subsequently calculated p-values for the overlaid environmental variables, and found that the four overlaid environmental variables are all significant with p<0.05.

Moreover, we applied non-metric multidimensional scaling (NMDS) to get a sense better sense of the distribution of U.S. states with respect to both the base and environmental continuous variables.

```{r, warning=F, message=F, results="hide"}
mds4 <- metaMDS(stlm_CA_env, distance="euclidean", k=4)
```



```{r, warning=F, message=F}
fig <- ordiplot(mds4, type = "none", cex = 1.1, main = "NMDS for COVID-19 Data")
#text(fig, "species", col = "red", cex = 0.5)
text(fig, "sites", col = "black", cex = 0.3)
plot(fit, cex=0.5)
tmp1 <- with(stlm_CA_env, ordisurf(mds4, Unemployment_Rate_2019_Log, add = TRUE), cex=0.4)
tmp2 <- with(stlm_CA_env, ordisurf(mds4, Death_Rate_2019_Log, add = TRUE, col = "green4"),cex=0.4)
tmp3 <- with(stlm_CA_env, ordisurf(mds4, Civilian_Labor_Force_2019_as_pct_Log, add = TRUE, col = "purple"), cex=0.4)
#tmp4 <- with(stlm_CA_env, ordisurf(mds4, Covid_Deaths_as_pct_Log, add = TRUE, col = "purple"))
```

From our first correspondence analysis plot including the first two correspondence analysis directions, we are able to deduce the similarities and differences between states with respect to the applied continuous variables. Overall, the counties seem evenly and scattered between the four quadrants. Generally, the higher values for the first correspondence axis is associated with higher civilian labor force participation, fewer COVID-19 cases/deaths, lower death rate, and lower unemployment. The second correspondence axis is associated primarily with poor masking behaviors, greater COVID-19 cases/deaths, and greater unemployment. These results perhaps indicate two different types of counties that are associated with high COVID-19 rates (those in poorer, disadvantaged areas and also those with poor masking behaviors). Interestingly, higher civilian labor force participation is associated with slightly higher COVID-19 deaths, a trend whose causes (e.g., more workplace exposure to COVID-19) necessitates further research. 

The NMDS plot reveals even more insight. We believe this plot with its contour lines optimally illustrates the distribution of the counties and their relations to the NMDS axes and environmental variables. Moreover, we can see that the contour lines are not exactly perpendicular to their respective blue dimensional axes, suggesting a more complex (non-linear) significant pattern of counties according to the environmental variables of unemployment, bachelor’s percentage, and civilian labor force percentage. This graph moreover clearly illustrates how states form clusters according to these variables. There is a clear clustering of states with higher death rates, unemployment rates, and COVID-19 deaths. Other states exist along a spectrum of these variables. 


# Conclusions and Discussion (add correspondence analysis)

This report examined connections between the economic, education, behavioral, and population data for the 3141 U.S. counties and COVID-19 infection and death rate data.

Using PCA, we reduced the dimensionality of our large dataset to 3 principle components to explain 73% of the total variability. We highlight that there are two main factors that are associated with risk of COVID-19 infection and death: 1) masking behaviors and 2) socioeconomic status. Masking and wealth are associated with lower COVID-19 infection and death rates. Using cluster analysis, we determined which counties are most similar to each other: there are very well-off counties with high mask compliance and low COVID-19 rates, moderately well-off counties with low-mask compliance and high COVID-19 rates, and impoverished counties with high COVID-19 rates. This clustering implies that differences in masking behaviors and COVID-19 infection may not be due to any sort of moral gap but more likely due to a gap in resources - it is a privilege to be able to stay informed on scientific discoveries, purchase masks, work from home, and maintain social distancing. We also note the that impoverished counties have much higher COVID-19 death rates and may have preexisting conditions that worsen its effects and lack quality healthcare or health insurance. Moreover, correspondence analysis for states revealed similar trends: higher COVID-19 infection and death is associated with less proclivity to mask, higher unemployment, and overall higher death rate. 

We can observe these connections, but we cannot make any cause-and-effect statements based on our current observational study. However, even without knowing the cause, we can say that vaccine and education efforts should be prioritized in underprivileged communities with lower masking rates - these communities are being hit the hardest by COVID-19.

# Points for Further Analysis

We hope that studies of COVID-19 death and infection rates will continue, even as vaccination rates increase, so we can find the communities who can benefit from public health efforts. We also hope that these public efforts extend beyond just COVID-19 assistance; our work has highlighted the connection between socioeconomic factors and infection and death rates. While we are unable to examine the causal nature of this relationship with this data set, hopefully future studies will probe at why this connection exists and present solutions.

We note that COVID-19 is a pandemic, impacting the entire world. Though we only studied counties in the United States, it would be worthwhile to study other countries to understand how to prioritize not only vaccination efforts in the U.S. but in the world. Vaccination is a world-wide effort, and none of us are protected until we are all protected.

