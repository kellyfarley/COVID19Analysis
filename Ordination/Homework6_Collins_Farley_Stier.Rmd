---
title: "S&DS 363 Homework 6"
author: "Evan Collins, Kelly Farley, Ken Stier"
date: "23 April 2021"
output:
  html_document:
   toc: yes
   toc_float:
     collapsed: no
  pdf_document:
    latex_engine : xelatex
---

```{r, echo=F, message=F, warning=F, cache=T}
# clear env
rm(list=ls())

# Load packages
library(car)
library(tidyverse)
library(MASS)
library(DiscriMiner)
library(klaR)
library(vegan)
#library(aplpack)
library(fpc)
library(cluster)
library(ape)
library(amap)

# Packages pertinent to Ordination
library(vegan) # eggplant
library(vegan3d)
library(mgcv)
library(rgl)
library(dplyr)
library(magrittr)
```

# Contributors

Evan Collins (evan.collins@yale.edu)

Kelly Farley (kelly.farley@yale.edu)

Ken Stier (ken.stier@yale.edu)

# The Dataset

*Raw dataset:*
COVID-19 infection and death statistics from U.S. counties (sourced from NYT), combined with economic, education, and population data (sourced from various government agencies) and also survey responses about mask-wearing frequencies (sourced from NYT). 3141 complete observations on 19 metric variables and 6 categorical variables. To avoid any outliers due to population size differences between counties, all variables are scaled as a percentage of population. Variable descriptions can be found [here](http://evancollins.com/variable_descriptions.html).

*Data of relevance for this pset:*

Counties are grouped by `Rural_Urban_Code_2013`. The USDA rural-urban Codes are numbered 1-9 with 1 being the most urban and 9 being the most rural. The counties were aggregated by rural-urban code, and mean values were taken for each of the continuous variables.

We look at five continuous variables describing each rural-urban county code: `Never_Wear_Mask_Survey`, `Rarely_Wear_Mask_Survey`, `Sometimes_Wear_Mask_Survey`, `Frequently_Wear_Mask_Survey`, `Always_Wear_Mask_Survey`. These variables reflect the fraction of people in the county who responded as such to a NYT survey inquiring about mask usage. This dat is stored in `data_ord_survey`.

For additional continuous variables, we look at eight continuous variables describing each rural-urban type: `Covid_Deaths_as_pct`, `Unemployment_Rate_2019`, `logMedian_Household_Income_2019`, `Death_Rate_2019`, `Birth_Rate_2019`, `Percent_Poverty_2019`, and `Percent_Adults_Less_Than_HS`, `Percent_Adults_Bachelors_or_Higher`. Note that the first two columns, `FIPS` and `County_Name` are included for documentation purposes. This data is stored in `data_ord_env`.



```{r}
# Process raw dataset as we have done in preceding psets

raw <- read.csv("https://evancollins.com/covid_and_demographics.csv")

# create categorical variables: rural-urban code (3 levels), region (4 variables)
raw <- 
  raw %>%
    mutate(region = case_when(
      State_Name %in% c("Washington", "Oregon", "California", "Nevada", "Idaho", "Montana", "Utah", "Arizona", "Wyoming", "Colorado", "New Mexico", "Alaska", "Hawaii") ~ "West",
      State_Name %in% c("North Dakota", "South Dakota", "Nebraska", "Kansas", "Minnesota", "Iowa", "Missouri", "Wisconsin", "Illinois", "Michigan", "Indiana", "Ohio") ~ "Midwest",
      State_Name %in% c("Texas", "Oklahoma", "Arkansas", "Louisiana", "Mississippi", "Tennessee", "Kentucky", "Alabama", "Georgia", "Florida", "South Carolina", "North Carolina", "Virginia", "West Virginia", "District of Columbia", "Delaware", "Maryland") ~ "South",
      State_Name %in% c("Pennsylvania", "New Jersey", "Connecticut", "Rhode Island", "Massachusetts", "New Hampshire", "Vermont", "Maine", "New York") ~ "Northeast"),
      rural_urban_code = case_when(
        Rural_Urban_Code_2013 %in% c(1, 2) ~ "Urban",
        Rural_Urban_Code_2013 %in% c(3, 4, 5) ~ "Suburban",
        Rural_Urban_Code_2013 %in% c(6, 7, 8, 9) ~ "Rural")
      )
raw$rural_urban_code <- as.factor(raw$rural_urban_code) # Rural is reference

# log transformations of our continuous variables
raw$logMedian_Household_Income_2019 <- log(raw$Median_Household_Income_2019 + 0.0001)
raw$logPercent_Poverty_2019 <- log(raw$Percent_Poverty_2019 + 0.0001)
raw$logCovid_Confirmed_Cases_as_pct <- log(raw$Covid_Confirmed_Cases_as_pct + 0.0001)
```

```{r}
# Dataset of interest for this pset
data_ord <- raw[, c(20, 5, 6, 7, 8, 9)]

# get averages of each variable by rural-urban code
data_ord_survey <- aggregate(Never_Wear_Mask_Survey ~ Rural_Urban_Code_2013, data_ord, mean)
data_ord_survey$Rarely_Wear_Mask_Survey <- aggregate(Rarely_Wear_Mask_Survey ~ Rural_Urban_Code_2013, data_ord, mean)$Rarely_Wear_Mask_Survey
data_ord_survey$Sometimes_Wear_Mask_Survey <- aggregate(Sometimes_Wear_Mask_Survey ~ Rural_Urban_Code_2013, data_ord, mean)$Sometimes_Wear_Mask_Survey
data_ord_survey$Frequently_Wear_Mask_Survey <- aggregate(Frequently_Wear_Mask_Survey ~ Rural_Urban_Code_2013, data_ord, mean)$Frequently_Wear_Mask_Survey
data_ord_survey$Always_Wear_Mask_Survey <- aggregate(Always_Wear_Mask_Survey ~ Rural_Urban_Code_2013, data_ord, mean)$Always_Wear_Mask_Survey

data_ord_survey1 <- data_ord_survey
data_ord_survey <- data_ord_survey1[,-1]
rownames(data_ord_survey) <- data_ord_survey1[,1]

```

```{r}
# Enviromental variables dataset 
data_ord_env_county <- raw[, c(20, 23, 10, 28, 18, 19, 13, 14, 15)]

data_ord_env <- aggregate(Covid_Deaths_as_pct ~ Rural_Urban_Code_2013, data_ord_env_county, mean)
data_ord_env$Unemployment_Rate_2019 <- aggregate(Unemployment_Rate_2019 ~ Rural_Urban_Code_2013, data_ord_env_county, mean)$Unemployment_Rate_2019
data_ord_env$logMedian_Household_Income_2019 <- aggregate(logMedian_Household_Income_2019 ~ Rural_Urban_Code_2013, data_ord_env_county, mean)$logMedian_Household_Income_2019
data_ord_env$Death_Rate_2019 <- aggregate(Death_Rate_2019 ~ Rural_Urban_Code_2013, data_ord_env_county, mean)$Death_Rate_2019
data_ord_env$Birth_Rate_2019 <- aggregate(Birth_Rate_2019 ~ Rural_Urban_Code_2013, data_ord_env_county, mean)$Birth_Rate_2019
data_ord_env$Percent_Poverty_2019 <- aggregate(Percent_Poverty_2019 ~ Rural_Urban_Code_2013, data_ord_env_county, mean)$Percent_Poverty_2019
data_ord_env$Percent_Adults_Less_Than_HS <- aggregate(Percent_Adults_Less_Than_HS ~ Rural_Urban_Code_2013, data_ord_env_county, mean)$Percent_Adults_Less_Than_HS
data_ord_env$Percent_Adults_Bachelors_or_Higher <- aggregate(Percent_Adults_Bachelors_or_Higher ~ Rural_Urban_Code_2013, data_ord_env_county, mean)$Percent_Adults_Bachelors_or_Higher

data_ord_env1 <- data_ord_env
data_ord_env <- data_ord_env1[,-1]
rownames(data_ord_env) <- data_ord_env1[,1]

```


# 1 

**Fit Correspondence Analysis to your data.**

Columns 2 through 6 contain the variable data. Correspondence analysis is performed using the `cca()` function.

```{r}
# No negative data anyways
# data_ord_survey <- data_ord_survey[apply(data_ord_survey[, 2:6], 1, sum) > 0, ]

#Perform correspondence analysis
data_ord_survey_ca <- cca(data_ord_survey)
```


# 2

**Discuss the inertia, make a two dimensional plot of the first two CA directions.**


```{r}
#plot results
plot(data_ord_survey_ca, main = "Correspondence Analysis for Rural-Urban Data", type = "n")
text(data_ord_survey_ca, dis = "wa", labels = rownames(data_ord_survey))
points(data_ord_survey_ca, pch = 21, col = "red", bg = "yellow", cex = 1.2)
text(data_ord_survey_ca, "species", col = "blue", cex = 0.8)
```


ISSUE IN CHUNK BELOW: WHY IS THERE NO "CONSTRAINED" FEEATURED, SO PROPORTION IS STRANGELY 1???
THIS WAS NOT THE CASE IN THE EXAMPLE R CODE. 

I THINK THIS PROBLEM MAYBE RELATED TO BASIC DATA ORGANIZATION?

```{r}
summary(data_ord_survey_ca)
```


Add environmental variables.

```{r}
plot(data_ord_survey_ca, main = "Correspondence Analysis for Rural-Urban Data", type = "n")
points(data_ord_survey_ca, pch = 19, col = "black", cex = 1)
text(data_ord_survey_ca, "species", col = "blue", cex = 1.1)
#add environmental variables
fit <- envfit(data_ord_survey_ca, data_ord_env, permutations = 1000)
plot(fit, col = "red", lwd = 3)
```

```{r}
#get significance - all environmental variables are significant
fit
```

We can see that all environmental variables are significant (p < 0.1) except `Birth_Rate_2019`. We will omit this variable from the environmental variable dataset for future analyses.

```{r}
data_ord_env <- subset(data_ord_env, select=-6)
```


This plot is somewhat hard to read (and may have a rudimentary arch), so we try detrended correspondence analysis. This is even harder to read. DCA uses the `decorana()` function.

```{r}
#detrended correspondence analysis
data_ord_survey_dca <- decorana(data_ord_survey)
plot(data_ord_survey_dca, main = "DCA for Rural-Urban Type", type = "n")
text(data_ord_survey_dca, display = c("sites"), labels = rownames(data_ord_survey), cex = 0.86)
points(data_ord_survey_dca, pch = 21, col = "red", bg = "yellow", cex = 0.6)
text(data_ord_survey_dca, "species", col = "blue", cex = 0.6)

#add environmental variables
fit <- envfit(data_ord_survey_dca, data_ord_env, permutations = 1000)
plot(fit, col = "red", lwd = 3)
```




# 3

**Comment on whether or not there is any evidence of 'data snaking' in higher dimensional space.**



# 4

**In a few sentences, describe what you conclude from your plot.**


# 5

**Perform Multidimensional Scaling (metric or non-metric) for 1, 2, and 3 dimensions.**

*first attempt - problematic because stresses are too low* (need to change)

```{r}
results <- matrix(NA, 21, 5)
#j is number of dimensions to try
for (j in 1:5){
  for (i in 1:20){
    temp <- data_ord_survey[shuffle(nrow(data_ord_survey)), 1]
    for (k in 2:6) { temp <- cbind(temp, data_ord_survey[shuffle(nrow(data_ord_survey)), k]) }
    #store stress
    results[i, j] <- metaMDS(temp, k = j, distance = "euclidean")$stress
  }
  results[21, j] <- metaMDS(data_ord_survey, k = j, distance = "euclidean")$stress
}
```

```{r}
#plot stress results

plot(c(1:5), results[21, ], type = "b", col = "blue", lwd = 3, 
     ylim = c(0, max(results)), xlab = "Dimensions", ylab = "Stress", pch = 19, 
     main = "MDS for Stream Data, Euclidean Distance")
mins <- apply(results[1:20, ], 2, min)
maxs <- apply(results[1:20, ], 2, max)
meds <- apply(results[1:20, ], 2, median)

for (i in 1:5){
  points(rep(i, 3), c(mins[i], meds[i], maxs[i]), type = "b", col = "red", lwd = 3, pch = 19)
}
legend(3.5, (.9*max(results)), c("MDS Solution", "20 Permutations"), lwd = 3, col = c("blue", "red"))
```





# 6

**Discuss the stress (or SStress) of each dimensional solution. Make a scree plot if you're able.**


# 7

**Make a two dimensional plot of your MDS results.**


# 8

**If possible, overlay some other continuous variable(s) to interpret your ordination axes. Calculate p-values for the overlaid additional variable(s). If you can, get some non-linear wireplots of the these overlaid variables (see examples online in R).**




# 9

**Again, assuming you have at least one additional continuous variable, perform canonical correspondence analysis.**





# 10

**Finally, write a paragraph or so comparing the methods you’ve used, discuss what conclusions you reach, etc.**


